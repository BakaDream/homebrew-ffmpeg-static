name: Build Native FFmpeg for Apple Silicon

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-native:
    runs-on: macos-14
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update > /dev/null 2>&1
        brew install --quiet pkg-config nasm yasm cmake autoconf automake libtool
        brew install --quiet x264 x265 lame opus libvorbis libvpx webp fdk-aac freetype fontconfig \
          libbluray openjpeg libass theora snappy aom vidstab zimg svt-av1 kvazaar harfbuzz
        brew link --overwrite nasm yasm autoconf automake libtool x264 x265 lame opus libvorbis libvpx webp fdk-aac \
          freetype fontconfig libbluray openjpeg libass theora snappy aom vidstab zimg svt-av1 kvazaar harfbuzz \
          > /dev/null 2>&1 || true
        export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$PKG_CONFIG_PATH"

    - name: Download FFmpeg source
      run: |
        if [ ! -d "ffmpeg-src" ]; then
          curl -L "https://ffmpeg.org/releases/ffmpeg-snapshot.tar.bz2" -o ffmpeg.tar.bz2
          tar -xjf ffmpeg.tar.bz2
          mv ffmpeg ffmpeg-src
          rm ffmpeg.tar.bz2
        fi

    - name: Configure FFmpeg for Apple Silicon
      working-directory: ffmpeg-src
      run: |
        export SOURCE="$(pwd)/build"
        mkdir -p $SOURCE
        ./configure \
          --prefix=${SOURCE} \
          --extra-cflags="-fno-stack-check" \
          --arch=arm64 \
          --cc=/usr/bin/clang \
          --enable-gpl \
          --enable-libbluray \
          --enable-libopenjpeg \
          --enable-libopus \
          --enable-libmp3lame \
          --enable-libx264 \
          --enable-libx265 \
          --enable-libvpx \
          --enable-libwebp \
          --enable-libass \
          --enable-libfreetype \
          --enable-fontconfig \
          --enable-libtheora \
          --enable-libvorbis \
          --enable-libsnappy \
          --enable-libaom \
          --enable-libvidstab \
          --enable-libzimg \
          --enable-libsvtav1 \
          --enable-libkvazaar \
          --enable-libharfbuzz \
          --pkg-config-flags=--static \
          --enable-ffplay \
          --enable-postproc \
          --enable-neon \
          --enable-runtime-cpudetect \
          --disable-indev=qtkit \
          --disable-indev=x11grab_xcb \
          --disable-shared \
          --enable-static

    - name: Build FFmpeg
      working-directory: ffmpeg-src
      run: make -j$(sysctl -n hw.ncpu)

    - name: Package binaries
      run: |
        mkdir -p release
        cp ffmpeg-src/ffmpeg release/
        cp ffmpeg-src/ffprobe release/
        cp ffmpeg-src/ffplay release/
        cd release
        tar -czf ../ffmpeg-apple-silicon-native-${{ github.ref_name }}.tar.gz *
        cd ..
        shasum -a 256 ffmpeg-apple-silicon-native-${{ github.ref_name }}.tar.gz > checksums.txt

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-apple-silicon-native
        path: |
          ffmpeg-apple-silicon-native-*.tar.gz
          checksums.txt
