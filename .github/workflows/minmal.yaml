name: Build FFmpeg macOS arm64 with deps

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    env:
      PREFIX: ${{ github.workspace }}/build
      PKG_CONFIG_PATH: ${{ github.workspace }}/build/lib/pkgconfig
      PATH: ${{ github.workspace }}/build/bin:$PATH

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          brew install yasm nasm cmake pkg-config automake autoconf libtool

      # Build x264
      - name: Build x264
        run: |
          git clone --depth 1 https://code.videolan.org/videolan/x264.git
          cd x264
          ./configure --prefix=$PREFIX --enable-static --disable-cli --host=arm-apple-darwin
          make -j$(sysctl -n hw.logicalcpu)
          make install

      # Build x265
      - name: Build x265
        run: |
          git clone --branch stable --depth 1 https://bitbucket.org/multicoreware/x265_git.git
          cd x265/build
          cmake -G "Unix Makefiles" -DCMAKE_INSTALL_PREFIX=$PREFIX -DENABLE_SHARED=OFF -DENABLE_CLI=OFF ../source
          make -j$(sysctl -n hw.logicalcpu)
          make install

      # Build fdk-aac
      - name: Build fdk-aac
        run: |
          git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git
          cd fdk-aac
          autoreconf -fiv
          ./configure --prefix=$PREFIX --enable-static --disable-shared
          make -j$(sysctl -n hw.logicalcpu)
          make install

      # Build opus
      - name: Build opus
        run: |
          git clone --depth 1 https://github.com/xiph/opus.git
          cd opus
          ./autogen.sh
          ./configure --prefix=$PREFIX --enable-static --disable-shared
          make -j$(sysctl -n hw.logicalcpu)
          make install

      # Build ffmpeg
      - name: Download and build ffmpeg
        run: |
          curl -L https://ffmpeg.org/releases/ffmpeg-6.1.1.tar.gz -o ffmpeg.tar.gz
          tar xzf ffmpeg.tar.gz
          cd ffmpeg-6.1.1
          ./configure \
            --prefix=$PREFIX \
            --pkg-config-flags="--static" \
            --extra-cflags="-I$PREFIX/include" \
            --extra-ldflags="-L$PREFIX/lib -static" \
            --enable-gpl --enable-nonfree \
            --enable-static --disable-shared \
            --enable-libx264 --enable-libx265 \
            --enable-libfdk-aac --enable-libopus
          make -j$(sysctl -n hw.logicalcpu)
          make install

      - name: Package ffmpeg
        run: |
          tar czf ffmpeg-macos-arm64-full.tar.gz -C $PREFIX bin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-arm64-full
          path: ffmpeg-macos-arm64-full.tar.gz