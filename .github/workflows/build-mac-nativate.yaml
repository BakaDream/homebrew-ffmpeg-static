name: Build Native FFmpeg for Apple Silicon

on:
  push:
    branches: [ main ]  # For development testing
  workflow_dispatch:

jobs:
  build-native:
    runs-on: macos-14  # Apple Silicon runner
    timeout-minutes: 180  # 3 hours max
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: æ‹‰å–æºç 
      run: |
        # å®šä¹‰æºç å­˜æ”¾ç›®å½•ï¼ˆä¸Žç¼–è¯‘è„šæœ¬ä¸­çš„COMPILEDä¿æŒä¸€è‡´ï¼‰
        COMPILED="./compile"

        # åˆ›å»ºç›®å½•ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
        mkdir -p ${COMPILED}
        echo "ðŸ“‚ å·²åˆ›å»ºæºç å­˜æ”¾ç›®å½•: ${COMPILED}"

        # æ‹‰å–æºç å‡½æ•°ï¼ˆé€šç”¨å‡½æ•°ï¼Œç®€åŒ–é‡å¤æ“ä½œï¼‰
        pull_source() {
            local name=$1
            local url=$2
            local dir=$3
            
            echo -e "\nðŸ” å¼€å§‹æ‹‰å–: ${name}"
            cd ${COMPILED} || exit 1
            
            # è‹¥ç›®æ ‡ç›®å½•å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤ï¼ˆé¿å…ç‰ˆæœ¬å†²çªï¼‰
            if [ -d "${dir}" ]; then
                echo "âš ï¸ æ£€æµ‹åˆ°å·²æœ‰${dir}ï¼Œæ­£åœ¨åˆ é™¤æ—§ç‰ˆæœ¬..."
                rm -rf ${dir}
            fi
            
            # æ ¹æ®URLç±»åž‹é€‰æ‹©æ‹‰å–æ–¹å¼ï¼ˆgitæˆ–taråŒ…ï¼‰
            if [[ ${url} == git@* || ${url} == https://*.git ]]; then
                # gitä»“åº“
                git clone --depth 1 ${url} ${dir}
            else
                # taråŒ…ï¼ˆæ”¯æŒ.tar.gz/.tar.xzç­‰ï¼‰
                local filename=$(basename ${url})
                wget -c ${url} -O ${filename} || { echo "âŒ ä¸‹è½½${name}å¤±è´¥"; exit 1; }
                
                # è‡ªåŠ¨è¯†åˆ«åŽ‹ç¼©æ ¼å¼å¹¶è§£åŽ‹
                if [[ ${filename} == *.tar.gz ]]; then
                    tar zxf ${filename}
                elif [[ ${filename} == *.tar.xz ]]; then
                    tar Jxf ${filename}
                elif [[ ${filename} == *.tar.bz2 ]]; then
                    tar jxf ${filename}
                else
                    echo "âŒ ä¸æ”¯æŒçš„åŽ‹ç¼©æ ¼å¼: ${filename}"
                    exit 1
                fi
                rm -f ${filename}  # è§£åŽ‹åŽåˆ é™¤å®‰è£…åŒ…
            fi
            
            # éªŒè¯æ‹‰å–ç»“æžœ
            if [ -d "${dir}" ]; then
                echo "âœ… ${name}æ‹‰å–æˆåŠŸ"
            else
                echo "âŒ ${name}æ‹‰å–å¤±è´¥"
                exit 1
            fi
        }

        # 1. NASMï¼ˆæ±‡ç¼–å™¨ï¼‰
        pull_source "NASM" \
            "https://www.nasm.us/pub/nasm/releasebuilds/2.16.01/nasm-2.16.01.tar.gz" \
            "nasm-2.16.01"

        # 2. pkg-config
        pull_source "pkg-config" \
            "https://pkg-config.freedesktop.org/releases/pkg-config-0.29.2.tar.gz" \
            "pkg-config-0.29.2"

        # 3. XZï¼ˆåŽ‹ç¼©å·¥å…·ï¼‰
        pull_source "XZ" \
            "https://tukaani.org/xz/xz-5.4.6.tar.gz" \
            "xz"

        # 4. ZLIB
        pull_source "ZLIB" \
            "https://zlib.net/zlib-1.2.13.tar.gz" \
            "zlib-1.2.13"

        # 5. CMake
        pull_source "CMake" \
            "https://cmake.org/files/v3.25/cmake-3.25.1.tar.gz" \
            "cmake-3.25.1"

        # 6. libxml2
        pull_source "libxml2" \
            "https://download.gnome.org/sources/libxml2/2.10/libxml2-2.10.3.tar.xz" \
            "libxml2-v2.10.3"

        # 7. LAMEï¼ˆMP3ç¼–ç å™¨ï¼‰
        pull_source "LAME" \
            "https://downloads.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz" \
            "lame"

        # 8. x264ï¼ˆH.264ç¼–ç å™¨ï¼‰
        pull_source "x264" \
            "git://git.videolan.org/x264.git" \
            "x264"

        # 9. x265ï¼ˆH.265ç¼–ç å™¨ï¼ŒNeonä¼˜åŒ–ç‰ˆï¼‰
        pull_source "x265Neon" \
            "https://bitbucket.org/multicoreware/x265_git.git" \
            "x265Neon"

        # 10. libvpxï¼ˆVP8/VP9ç¼–ç å™¨ï¼‰
        pull_source "libvpx" \
            "https://github.com/webmproject/libvpx.git" \
            "libvpx"

        # 11. Expatï¼ˆXMLè§£æžåº“ï¼‰
        pull_source "Expat" \
            "https://github.com/libexpat/libexpat/releases/download/R_2_4_8/expat-2.4.8.tar.gz" \
            "expat-2.4.8"

        # 12. Gettextï¼ˆå›½é™…åŒ–åº“ï¼‰
        pull_source "Gettext" \
            "https://ftp.gnu.org/pub/gnu/gettext/gettext-0.21.1.tar.gz" \
            "gettext-0.21.1"

        # 13. libpngï¼ˆPNGå›¾åƒå¤„ç†ï¼‰
        pull_source "libpng" \
            "https://downloads.sourceforge.net/project/libpng/libpng16/1.6.37/libpng-1.6.37.tar.gz" \
            "libpng-1.6.37"

        # 14. Encaï¼ˆç¼–ç æ£€æµ‹åº“ï¼‰
        pull_source "Enca" \
            "https://downloads.sourceforge.net/project/enca/enca/1.19/enca-1.19.tar.gz" \
            "enca-1.19"

        # 15. FriBidiï¼ˆæ–‡æœ¬æŽ’ç‰ˆåº“ï¼‰
        pull_source "FriBidi" \
            "https://github.com/fribidi/fribidi/releases/download/v1.0.12/fribidi-1.0.12.tar.xz" \
            "fribidi-1.0.12"

        # 16. FreeTypeï¼ˆå­—ä½“æ¸²æŸ“åº“ï¼‰
        pull_source "FreeType" \
            "https://download.savannah.gnu.org/releases/freetype/freetype-2.12.1.tar.gz" \
            "freetype-2.12.1"

        # 17. Fontconfigï¼ˆå­—ä½“é…ç½®åº“ï¼‰
        pull_source "Fontconfig" \
            "https://www.freedesktop.org/software/fontconfig/release/fontconfig-2.14.2.tar.xz" \
            "fontconfig-2.14.2"

        # 18. HarfBuzzï¼ˆæ–‡å­—æŽ’ç‰ˆå¼•æ“Žï¼‰
        pull_source "HarfBuzz" \
            "https://github.com/harfbuzz/harfbuzz/releases/download/6.0.0/harfbuzz-6.0.0.tar.xz" \
            "harfbuzz-6.0.0"

        # 19. SDL2ï¼ˆå¤šåª’ä½“åº“ï¼‰
        pull_source "SDL2" \
            "https://www.libsdl.org/release/SDL2-2.26.2.tar.gz" \
            "SDL2-2.26.2"

        # 20. libassï¼ˆå­—å¹•æ¸²æŸ“åº“ï¼‰
        pull_source "libass" \
            "https://github.com/libass/libass/releases/download/0.17.0/libass-0.17.0.tar.xz" \
            "libass-0.17.0"

        # 21. Opusï¼ˆéŸ³é¢‘ç¼–ç å™¨ï¼‰
        pull_source "Opus" \
            "https://downloads.xiph.org/releases/opus/opus-1.3.1.tar.gz" \
            "opus-1.3.1"

        # 22. liboggï¼ˆOggå®¹å™¨æ ¼å¼ï¼‰
        pull_source "libogg" \
            "https://downloads.xiph.org/releases/ogg/libogg-1.3.5.tar.gz" \
            "libogg-1.3.5"

        # 23. libvorbisï¼ˆVorbiséŸ³é¢‘ç¼–ç å™¨ï¼‰
        pull_source "libvorbis" \
            "https://downloads.xiph.org/releases/vorbis/libvorbis-1.3.7.tar.gz" \
            "libvorbis-1.3.7"

        # 24. libtheoraï¼ˆTheoraè§†é¢‘ç¼–ç å™¨ï¼‰
        pull_source "libtheora" \
            "https://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.gz" \
            "libtheora-1.1.1"

        # 25. vid.stabï¼ˆè§†é¢‘é˜²æŠ–åº“ï¼‰
        pull_source "vid.stab" \
            "https://github.com/georgmartius/vid.stab.git" \
            "vidstab-master"

        # 26. Snappyï¼ˆåŽ‹ç¼©åº“ï¼‰
        pull_source "Snappy" \
            "https://github.com/google/snappy/archive/refs/tags/1.1.9.tar.gz" \
            "snappy"

        # 27. OpenJPEGï¼ˆJPEG 2000åº“ï¼‰
        pull_source "OpenJPEG" \
            "https://github.com/uclouvain/openjpeg/archive/refs/tags/v2.5.0.tar.gz" \
            "openjpeg-2.5.0"

        # 28. AOMï¼ˆAV1ç¼–ç å™¨ï¼‰
        pull_source "AOM" \
            "https://aomedia.googlesource.com/aom" \
            "aom"

        # 29. libwebpï¼ˆWebPå›¾åƒåº“ï¼‰
        pull_source "libwebp" \
            "https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.1.0.tar.gz" \
            "libwebp-1.1.0"

        # 30. zimgï¼ˆå›¾åƒç¼©æ”¾åº“ï¼‰
        pull_source "zimg" \
            "https://github.com/sekrit-twc/zimg/archive/refs/tags/release-3.0.2.tar.gz" \
            "zimg-release-3.0.2"

        # 31. SVT-AV1ï¼ˆAV1ç¼–ç å™¨ï¼‰
        pull_source "SVT-AV1" \
            "https://github.com/AOMediaCodec/SVT-AV1.git" \
            "SVT-AV1-master"

        # 32. Kvazaarï¼ˆHEVCç¼–ç å™¨ï¼‰
        pull_source "Kvazaar" \
            "https://github.com/ultravideo/kvazaar/archive/refs/tags/v2.2.0.tar.gz" \
            "kvazaar-2.2.0"

        # 33. libudfreadï¼ˆUDFæ ¼å¼è¯»å–åº“ï¼‰
        pull_source "libudfread" \
            "https://code.videolan.org/videolan/libudfread.git" \
            "libudfread"

        # 34. libblurayï¼ˆè“å…‰æ’­æ”¾åº“ï¼‰
        pull_source "libbluray" \
            "https://code.videolan.org/videolan/libbluray.git" \
            "libbluray"

        # 35. FFmpegï¼ˆä¸»ç¨‹åºï¼‰
        pull_source "FFmpeg" \
            "https://github.com/FFmpeg/FFmpeg.git" \
            "ffmpeg"

        echo -e "\nðŸŽ‰ æ‰€æœ‰æºç æ‹‰å–å®Œæˆï¼å­˜æ”¾ç›®å½•ï¼š${COMPILED}"
        echo "ä¸‹ä¸€æ­¥ï¼šæ‰§è¡Œç¼–è¯‘è„šæœ¬å¼€å§‹ç¼–è¯‘"

    - name: ç¼–è¯‘å…¨éƒ¨
      run: |
        # å®šä¹‰æœ¬åœ°è·¯å¾„ï¼ˆæ›¿ä»£ramdiskè·¯å¾„ï¼‰
        SOURCE="./sw"
        COMPILED="./compile"

        # åˆ›å»ºæ‰€éœ€ç›®å½•
        mkdir -p ${SOURCE}
        mkdir -p ${COMPILED}

        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export PATH=${SOURCE}/bin:$PATH
        export CC=clang && export PKG_CONFIG_PATH="${SOURCE}/lib/pkgconfig"

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ NASM'

        # ç¼–è¯‘NASM
        cd ${COMPILED}/nasm-2.16.01 || exit 1
        ./configure --prefix=${SOURCE}
        make -j$(nproc)  # è‡ªåŠ¨æ£€æµ‹CPUæ ¸å¿ƒæ•°è®¾ç½®çº¿ç¨‹
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ PKG-Config'

        # ç¼–è¯‘PKG-Config
        cd ${COMPILED}/pkg-config-0.29.2 || exit 1
        export LDFLAGS="-framework Foundation -framework Cocoa"
        ./configure --prefix=${SOURCE} --with-pc-path=${SOURCE}/lib/pkgconfig --with-internal-glib --disable-shared --enable-static
        make -j$(nproc)
        make install
        unset LDFLAGS
        sleep 1

        # ç¼–è¯‘XZ
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ XZ'
        cd ${COMPILED}/xz || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static --disable-docs --disable-examples
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ ZLIB'

        # ç¼–è¯‘ZLIB
        cd ${COMPILED}/zlib-1.2.13 || exit 1
        ./configure --prefix=${SOURCE} --static
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ CMake'

        # ç¼–è¯‘CMAKE
        cd ${COMPILED}/cmake-3.25.1 || exit 1
        ./configure --prefix=${SOURCE}
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libxml2'

        # ç¼–è¯‘libxml2
        cd ${COMPILED}/libxml2-v2.10.3 || exit 1
        ./autogen.sh
        ./configure --prefix=${SOURCE} --disable-shared --enable-static --without-python
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Lame'

        # ç¼–è¯‘Lame
        cd ${COMPILED}/lame || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ X264'

        # ç¼–è¯‘x264
        cd ${COMPILED}/x264 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static --enable-pic
        make -j$(nproc)
        make install
        make install-lib-static
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ X265'

        # ç¼–è¯‘x265
        rm -f ${SOURCE}/include/x265*.h 2>/dev/null
        rm -f ${SOURCE}/lib/libx265.a 2>/dev/null

        echo 'â™»ï¸ X265 12bit'
        cd ${COMPILED}/x265Neon/source || exit 1
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DHIGH_BIT_DEPTH=ON -DMAIN12=ON -DENABLE_SHARED=NO -DEXPORT_C_API=NO -DENABLE_CLI=OFF .
        make -j$(nproc)
        mv libx265.a libx265_main12.a
        make clean-generated
        rm CMakeCache.txt

        echo 'â™»ï¸ X265 10bit'
        cd ${COMPILED}/x265Neon/source || exit 1
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DHIGH_BIT_DEPTH=ON -DMAIN10=ON -DENABLE_HDR10_PLUS=ON -DENABLE_SHARED=NO -DEXPORT_C_API=NO -DENABLE_CLI=OFF .
        make clean
        make -j$(nproc)
        mv libx265.a libx265_main10.a
        make clean-generated && rm CMakeCache.txt

        echo 'â™»ï¸ X265 full'
        cd ${COMPILED}/x265Neon/source || exit 1
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DEXTRA_LIB="x265_main10.a;x265_main12.a" -DEXTRA_LINK_FLAGS=-L. -DLINKED_10BIT=ON -DLINKED_12BIT=ON -DENABLE_SHARED=OFF -DENABLE_CLI=OFF .
        make clean
        make -j$(nproc)
        mv libx265.a libx265_main.a
        libtool -static -o libx265.a libx265_main.a libx265_main10.a libx265_main12.a 2>/dev/null
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libvpx'

        # ç¼–è¯‘VPX
        cd ${COMPILED}/libvpx || exit 1
        ./configure --prefix=${SOURCE} --enable-vp8 --enable-postproc --enable-vp9-postproc --enable-vp9-highbitdepth --disable-examples --disable-docs --enable-multi-res-encoding --disable-unit-tests --enable-pic --disable-shared
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Expat'

        # ç¼–è¯‘EXPAT
        cd ${COMPILED}/expat-2.4.8 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Gettext'

        # ç¼–è¯‘Gettext
        cd ${COMPILED}/gettext-0.21.1 || exit 1
        ./configure --prefix=${SOURCE} --disable-dependency-tracking --disable-silent-rules --disable-debug --with-included-gettext --with-included-glib \
        --with-included-libcroco --with-included-libunistring --with-included-libxml --with-emacs --disable-java --disable-native-java --disable-csharp \
        --disable-shared --enable-static --without-git --without-cvs --disable-docs --disable-examples
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libpng'

        # ç¼–è¯‘LIBPNG
        cd ${COMPILED}/libpng-1.6.37 || exit 1
        ./configure --prefix=${SOURCE} --disable-dependency-tracking --disable-silent-rules --enable-static --disable-shared
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Enca'

        # ç¼–è¯‘ENCA
        cd ${COMPILED}/enca-1.19 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ FriBidi'

        # ç¼–è¯‘FRIBIDI
        cd ${COMPILED}/fribidi-1.0.12 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static --disable-silent-rules --disable-debug --disable-dependency-tracking
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ FreeType'

        # ç¼–è¯‘FREETYPE
        cd ${COMPILED}/freetype-2.12.1 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static --enable-freetype-config
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Fontconfig'

        # ç¼–è¯‘FONTCONFIG
        cd ${COMPILED}/fontconfig-2.14.2 || exit 1
        ./configure --prefix=${SOURCE} --enable-iconv --disable-libxml2 --disable-dependency-tracking --disable-silent-rules --disable-shared --enable-static
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ HarfBuzz'

        # ç¼–è¯‘HARFBUZZ
        cd ${COMPILED}/harfbuzz-6.0.0 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ SDL2'

        # ç¼–è¯‘SDL
        cd ${COMPILED}/SDL2-2.26.2 || exit 1
        ./autogen.sh
        ./configure --prefix=${SOURCE} --disable-shared --enable-static --without-x --enable-hidapi
        make -j$(nproc)
        make install

        # ç¼–è¯‘LIBASS
        cd ${COMPILED}/libass-0.17.0 || exit 1
        ./configure --prefix=${SOURCE} --disable-fontconfig --disable-shared --enable-static
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Opus'

        # ç¼–è¯‘OPUS
        cd ${COMPILED}/opus-1.3.1 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static
        make -j$(nproc)
        make install
        sleep 1

        # ç¼–è¯‘LIBOGG
        cd ${COMPILED}/libogg-1.3.5 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static --disable-dependency-tracking
        make -j$(nproc)
        make install
        sleep 1

        # ç¼–è¯‘LIBVORBIS
        cd ${COMPILED}/libvorbis-1.3.7 || exit 1
        ./configure --prefix=${SOURCE} --with-ogg-libraries=${SOURCE}/lib --with-ogg-includes=${SOURCE}/include/ --enable-static --disable-shared
        make -j$(nproc)
        make install
        sleep 1

        # ç¼–è¯‘libtheora
        cd ${COMPILED}/libtheora-1.1.1 || exit 1
        ./configure --prefix=${SOURCE} --disable-asm --with-ogg-libraries=${SOURCE}/lib --with-ogg-includes=${SOURCE}/include/ --with-vorbis-libraries=${SOURCE}/lib --with-vorbis-includes=${SOURCE}/include/ --enable-static --disable-shared
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Vid-stab'

        # ç¼–è¯‘Vidstab
        cd ${COMPILED}/vidstab-master || exit 1
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DLIBTYPE=STATIC -DBUILD_SHARED_LIBS=OFF -DUSE_OMP=OFF -DENABLE_SHARED=off .
        make -j$(nproc)
        make install
        sleep 1

        # ç¼–è¯‘SNAPPY
        cd ${COMPILED}/snappy || exit 1
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DENABLE_SHARED=OFF -DENABLE_CLI=OFF .
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ OpenJPEG'

        # ç¼–è¯‘OpenJPEG
        cd ${COMPILED}/openjpeg-2.5.0 || exit 1
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DENABLE_C_DEPS=ON -DLIBTYPE=STATIC -DENABLE_SHARED=OFF -DENABLE_STATIC=ON .
        make -j$(nproc)
        make install
        rm ${SOURCE}/lib/libopenjp2.2.5.0.dy* 2>/dev/null
        rm ${SOURCE}/lib/libopenjp2.dy* 2>/dev/null
        rm ${SOURCE}/lib/libopenjp2.7.dy* 2>/dev/null

        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ AOM'

        # ç¼–è¯‘AOM
        cd ${COMPILED}/aom || exit 1
        mkdir -p aom_build
        cd aom_build || exit 1
        cmake ${COMPILED}/aom -DENABLE_TESTS=0 -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DLIBTYPE=STATIC -DAOM_TARGET_CPU=ARM64 -DCONFIG_RUNTIME_CPU_DETECT=0
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libwebp'

        # ç¼–è¯‘WEBP
        cd ${COMPILED}/libwebp-1.1.0 || exit 1
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DENABLE_C_DEPS=ON -DLIBTYPE=STATIC -DENABLE_SHARED=OFF -DENABLE_STATIC=ON .
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ zimg'
        cd ${COMPILED}/zimg-release-3.0.2 || exit 1
        ./autogen.sh
        ./configure --prefix=${SOURCE} --disable-shared --enable-static
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ SVT-AV1'

        # ç¼–è¯‘SVT-AV1
        cd ${COMPILED}/SVT-AV1-master || exit 1
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} -DCMAKE_BUILD_TYPE=Release -DBUILD_DEC=OFF -DBUILD_SHARED_LIBS=OFF -DLIBTYPE=STATIC -DENABLE_SHARED=OFF -DENABLE_STATIC=ON .
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Kvazaar'

        # ç¼–è¯‘KVAZAAR
        cd ${COMPILED}/kvazaar-2.2.0 || exit 1
        ./configure --prefix=${SOURCE} --disable-shared --enable-static
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libudfread'

        # ç¼–è¯‘libudfread
        cd ${COMPILED}/libudfread || exit 1
        ./bootstrap
        ./configure --prefix=${SOURCE} --disable-shared --enable-static
        make -j$(nproc)
        make install
        sleep 1

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libbluray'

        # ç¼–è¯‘libbluray
        cd ${COMPILED}/libbluray || exit 1
        ./bootstrap
        ./configure --prefix=${SOURCE} --disable-shared --enable-static --disable-dependency-tracking --disable-silent-rules --without-libxml2 --without-freetype --disable-doxygen-doc --disable-bdjava-jar
        make -j$(nproc)
        make install

        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ FFmpeg'

        # ç¼–è¯‘FFMPEG
        cd ${COMPILED}/ffmpeg || exit 1
        export LDFLAGS="-L${SOURCE}/lib"
        export CFLAGS="-I${SOURCE}/include"
        export LDFLAGS="$LDFLAGS -framework VideoToolbox"
        ./configure \
          --prefix=${SOURCE} \
          --extra-cflags="-fno-stack-check" \
          --arch=arm64 \
          --cc=/usr/bin/clang \
          --enable-gpl \
          --enable-libbluray \
          --enable-libopenjpeg \
          --enable-libopus \
          --enable-libmp3lame \
          --enable-libx264 \
          --enable-libx265 \
          --enable-libvpx \
          --enable-libwebp \
          --enable-libass \
          --enable-libfreetype \
          --enable-fontconfig \
          --enable-libtheora \
          --enable-libvorbis \
          --enable-libsnappy \
          --enable-libaom \
          --enable-libvidstab \
          --enable-libzimg \
          --enable-libsvtav1 \
          --enable-libkvazaar \
          --enable-libharfbuzz \
          --pkg-config-flags=--static \
          --enable-ffplay \
          --enable-postproc \
          --enable-neon \
          --enable-runtime-cpudetect \
          --disable-indev=qtkit \
          --disable-indev=x11grab_xcb
        make -j$(nproc)
        make install
        
   
    - name: Test built binaries
      run: |
        # äºŒè¿›åˆ¶æ–‡ä»¶ä½äºŽç¼–è¯‘è¾“å‡ºç›®å½•çš„binæ–‡ä»¶å¤¹
        export BIN_DIR="./sw/bin"
        ${BIN_DIR}/ffmpeg -version | head -1
        ${BIN_DIR}/ffprobe -version | head -1
        file ${BIN_DIR}/ffmpeg | head -1
        
        # æµ‹è¯•VideoToolboxæ”¯æŒ
        ${BIN_DIR}/ffmpeg -hide_banner -encoders 2>/dev/null | grep -q videotoolbox && echo "âœ… VideoToolbox acceleration available" || echo "âŒ VideoToolbox acceleration missing"
        
        # æµ‹è¯•è¿åŠ¨å‘é‡æ”¯æŒ
        ${BIN_DIR}/ffmpeg -hide_banner -filters 2>/dev/null | grep -q codecview && echo "âœ… Motion vectors support available" || echo "âŒ Motion vectors support missing"
        
        echo "âœ… Binary tests completed"
        
    - name: Package binaries
      run: |
        mkdir -p release
        # ä»Žç¼–è¯‘è¾“å‡ºç›®å½•å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
        cp ./sw/bin/ffmpeg release/
        cp ./sw/bin/ffprobe release/
        cp ./sw/bin/ffplay release/ 2>/dev/null || true
        
        cd release
        tar -czf ../ffmpeg-apple-silicon-native-${{ github.ref_name }}.tar.gz *
        cd ..
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        shasum -a 256 ffmpeg-apple-silicon-native-${{ github.ref_name }}.tar.gz > checksums.txt
        
        echo "âœ… Binaries packaged successfully"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-apple-silicon-native
        path: |
          ffmpeg-apple-silicon-native-*.tar.gz
          checksums.txt