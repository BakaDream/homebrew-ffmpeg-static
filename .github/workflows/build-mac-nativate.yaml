name: Build Native FFmpeg for Apple Silicon

on:
  push:
    branches: [ main ]  # æ¨é€è‡³mainåˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-native:
    runs-on: macos-14  # ä½¿ç”¨Apple Siliconæ¶æ„çš„macOS runner
    timeout-minutes: 180  # æœ€é•¿è¿è¡Œæ—¶é—´3å°æ—¶

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # æ‹‰å–å½“å‰ä»“åº“ä»£ç 

    - name: æ‹‰å–æºç ï¼ˆç»Ÿä¸€ç›®å½•åï¼Œä¸å¸¦ç‰ˆæœ¬å·ï¼‰
      run: |
        # å®šä¹‰æºç å­˜æ”¾ç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰
        COMPILED="${GITHUB_WORKSPACE}/compile"
        
        # åˆ›å»ºç›®å½•å¹¶å¼ºåˆ¶æ ¡éªŒ
        echo "ğŸ“‚ å°è¯•åˆ›å»ºæºç å­˜æ”¾ç›®å½•: ${COMPILED}"
        mkdir -p ${COMPILED} || { echo "âŒ æ— æ³•åˆ›å»ºç›®å½•${COMPILED}ï¼ˆå¯èƒ½æƒé™ä¸è¶³ï¼‰"; exit 1; }
        if [ ! -d "${COMPILED}" ]; then
            echo "âŒ ç›®å½•${COMPILED}åˆ›å»ºå¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
        fi
        echo "ğŸ“‚ æºç å­˜æ”¾ç›®å½•åˆ›å»ºæˆåŠŸ: ${COMPILED}"

        # æ‹‰å–æºç å‡½æ•°ï¼ˆæ”¯æŒè§£å‹æ—¶é‡å‘½åç›®å½•ï¼Œå»æ‰ç‰ˆæœ¬å·ï¼‰
        pull_source() {
            local name=$1      # åº“åç§°ï¼ˆç”¨äºæ—¥å¿—ï¼‰
            local url=$2       # æºç åœ°å€ï¼ˆgitä»“åº“æˆ–taråŒ…ï¼‰
            local target_dir=$3  # ç›®æ ‡ç›®å½•ï¼ˆä¸å¸¦ç‰ˆæœ¬å·ï¼‰
            
            echo -e "\nğŸ” å¼€å§‹æ‹‰å–: ${name}"
            cd ${COMPILED} || { echo "âŒ æ— æ³•è¿›å…¥ç›®å½•${COMPILED}"; exit 1; }
            
            # æ¸…ç†æ—§ç›®å½•ï¼ˆè‹¥å­˜åœ¨ï¼‰
            if [ -d "${target_dir}" ]; then
                echo "âš ï¸ æ£€æµ‹åˆ°å·²æœ‰${target_dir}ï¼Œåˆ é™¤æ—§ç‰ˆæœ¬..."
                rm -rf ${target_dir} || { echo "âŒ æ— æ³•åˆ é™¤æ—§ç›®å½•${target_dir}"; exit 1; }
            fi
            
            # æ ¹æ®URLç±»å‹é€‰æ‹©æ‹‰å–æ–¹å¼ï¼ˆç»Ÿä¸€ç›®å½•åä¸ºtarget_dirï¼‰
            if [[ ${url} == git@* || ${url} == https://*.git ]]; then
                # gitå…‹éš†ï¼šç›´æ¥æŒ‡å®šç›®æ ‡ç›®å½•ï¼ˆå¤©ç„¶ä¸å¸¦ç‰ˆæœ¬å·ï¼‰
                git clone --depth 1 ${url} ${target_dir} || { echo "âŒ gitå…‹éš†${name}å¤±è´¥"; exit 1; }
            else
                # ä¸‹è½½taråŒ…å¹¶è§£å‹ï¼ŒåŒæ—¶é‡å‘½åæ ¹ç›®å½•ï¼ˆå»æ‰ç‰ˆæœ¬å·ï¼‰
                local filename=$(basename ${url})
                echo "ğŸ“¥ ä¸‹è½½${name}åŒ…: ${filename}"
                wget -c ${url} -O ${filename} || { echo "âŒ ä¸‹è½½${name}å¤±è´¥"; exit 1; }
                
                # è§£å‹æ—¶é€šè¿‡--transformé‡å‘½åæ ¹ç›®å½•ï¼ˆæ ¸å¿ƒï¼šå°†å‹ç¼©åŒ…å†…çš„ç›®å½•åæ›¿æ¢ä¸ºtarget_dirï¼‰
                if [[ ${filename} == *.tar.gz ]]; then
                    tar zxf ${filename} --transform "s/^[^\/]*/${target_dir}/" || { echo "âŒ è§£å‹${filename}å¤±è´¥"; exit 1; }
                elif [[ ${filename} == *.tar.xz ]]; then
                    tar Jxf ${filename} --transform "s/^[^\/]*/${target_dir}/" || { echo "âŒ è§£å‹${filename}å¤±è´¥"; exit 1; }
                elif [[ ${filename} == *.tar.bz2 ]]; then
                    tar jxf ${filename} --transform "s/^[^\/]*/${target_dir}/" || { echo "âŒ è§£å‹${filename}å¤±è´¥"; exit 1; }
                else
                    echo "âŒ ä¸æ”¯æŒçš„å‹ç¼©æ ¼å¼: ${filename}"
                    exit 1
                fi
                rm -f ${filename}  # è§£å‹ååˆ é™¤å®‰è£…åŒ…
            fi
            
            # éªŒè¯ç›®å½•æ˜¯å¦åˆ›å»ºæˆåŠŸ
            if [ -d "${target_dir}" ]; then
                echo "âœ… ${name}æ‹‰å–æˆåŠŸï¼ˆç›®å½•: ${target_dir}ï¼‰"
            else
                echo "âŒ ${name}æ‹‰å–å¤±è´¥ï¼ˆç›®æ ‡ç›®å½•${target_dir}æœªåˆ›å»ºï¼‰"
                exit 1
            fi
        }

        # æ‹‰å–å„ä¾èµ–æºç ï¼ˆç›®æ ‡ç›®å½•å‡ä¸å¸¦ç‰ˆæœ¬å·ï¼‰
        # 1. æ±‡ç¼–å™¨ï¼ˆnasm-2.16.01.tar.gz â†’ nasmï¼‰
        pull_source "NASM" \
            "https://www.nasm.us/pub/nasm/releasebuilds/2.16.01/nasm-2.16.01.tar.gz" \
            "nasm"

        # 2. åŒ…ç®¡ç†å·¥å…·ï¼ˆpkg-config-0.29.2.tar.gz â†’ pkg-configï¼‰
        pull_source "pkg-config" \
            "https://pkg-config.freedesktop.org/releases/pkg-config-0.29.2.tar.gz" \
            "pkg-config"

        # 3. å‹ç¼©å·¥å…·ï¼ˆxz-5.4.6.tar.gz â†’ xzï¼‰
        pull_source "XZ" \
            "https://tukaani.org/xz/xz-5.4.6.tar.gz" \
            "xz"

        # 4. å‹ç¼©åº“ï¼ˆzlib-1.2.13.tar.gz â†’ zlibï¼‰
        pull_source "ZLIB" \
            "https://zlib.net/zlib-1.2.13.tar.gz" \
            "zlib"

        # 5. æ„å»ºå·¥å…·ï¼ˆcmake-3.25.1.tar.gz â†’ cmakeï¼‰
        pull_source "CMake" \
            "https://cmake.org/files/v3.25/cmake-3.25.1.tar.gz" \
            "cmake"

        # 6. XMLè§£æåº“ï¼ˆlibxml2-2.10.3.tar.xz â†’ libxml2ï¼‰
        pull_source "libxml2" \
            "https://download.gnome.org/sources/libxml2/2.10/libxml2-2.10.3.tar.xz" \
            "libxml2"

        # 7. MP3ç¼–ç å™¨ï¼ˆlame-3.100.tar.gz â†’ lameï¼‰
        pull_source "LAME" \
            "https://downloads.sourceforge.net/project/lame/lame/3.100/lame-3.100.tar.gz" \
            "lame"

        # 8. H.264ç¼–ç å™¨ï¼ˆgitå…‹éš† â†’ x264ï¼‰
        pull_source "x264" \
            "git://git.videolan.org/x264.git" \
            "x264"

        # 9. H.265ç¼–ç å™¨ï¼ˆgitå…‹éš† â†’ x265Neonï¼‰
        pull_source "x265Neon" \
            "https://bitbucket.org/multicoreware/x265_git.git" \
            "x265Neon"

        # 10. VP8/VP9ç¼–ç å™¨ï¼ˆgitå…‹éš† â†’ libvpxï¼‰
        pull_source "libvpx" \
            "https://github.com/webmproject/libvpx.git" \
            "libvpx"

        # 11. XMLè§£æåº“ï¼ˆexpat-2.4.8.tar.gz â†’ expatï¼‰
        pull_source "Expat" \
            "https://github.com/libexpat/libexpat/releases/download/R_2_4_8/expat-2.4.8.tar.gz" \
            "expat"

        # 12. å›½é™…åŒ–åº“ï¼ˆgettext-0.21.1.tar.gz â†’ gettextï¼‰
        pull_source "Gettext" \
            "https://ftp.gnu.org/pub/gnu/gettext/gettext-0.21.1.tar.gz" \
            "gettext"

        # 13. PNGå›¾åƒå¤„ç†åº“ï¼ˆlibpng-1.6.37.tar.gz â†’ libpngï¼‰
        pull_source "libpng" \
            "https://downloads.sourceforge.net/project/libpng/libpng16/1.6.37/libpng-1.6.37.tar.gz" \
            "libpng"

        # 14. ç¼–ç æ£€æµ‹åº“ï¼ˆenca-1.19.tar.gz â†’ encaï¼‰
        pull_source "Enca" \
            "https://downloads.sourceforge.net/project/enca/enca/1.19/enca-1.19.tar.gz" \
            "enca"

        # 15. æ–‡æœ¬æ’ç‰ˆåº“ï¼ˆfribidi-1.0.12.tar.xz â†’ fribidiï¼‰
        pull_source "FriBidi" \
            "https://github.com/fribidi/fribidi/releases/download/v1.0.12/fribidi-1.0.12.tar.xz" \
            "fribidi"

        # 16. å­—ä½“æ¸²æŸ“åº“ï¼ˆfreetype-2.12.1.tar.gz â†’ freetypeï¼‰
        pull_source "FreeType" \
            "https://download.savannah.gnu.org/releases/freetype/freetype-2.12.1.tar.gz" \
            "freetype"

        # 17. å­—ä½“é…ç½®åº“ï¼ˆfontconfig-2.14.2.tar.xz â†’ fontconfigï¼‰
        pull_source "Fontconfig" \
            "https://www.freedesktop.org/software/fontconfig/release/fontconfig-2.14.2.tar.xz" \
            "fontconfig"

        # 18. æ–‡å­—æ’ç‰ˆå¼•æ“ï¼ˆharfbuzz-6.0.0.tar.xz â†’ harfbuzzï¼‰
        pull_source "HarfBuzz" \
            "https://github.com/harfbuzz/harfbuzz/releases/download/6.0.0/harfbuzz-6.0.0.tar.xz" \
            "harfbuzz"

        # 19. å¤šåª’ä½“åº“ï¼ˆSDL2-2.26.2.tar.gz â†’ sdl2ï¼‰
        pull_source "SDL2" \
            "https://www.libsdl.org/release/SDL2-2.26.2.tar.gz" \
            "sdl2"

        # 20. å­—å¹•æ¸²æŸ“åº“ï¼ˆlibass-0.17.0.tar.xz â†’ libassï¼‰
        pull_source "libass" \
            "https://github.com/libass/libass/releases/download/0.17.0/libass-0.17.0.tar.xz" \
            "libass"

        # 21. éŸ³é¢‘ç¼–ç å™¨ï¼ˆopus-1.3.1.tar.gz â†’ opusï¼‰
        pull_source "Opus" \
            "https://downloads.xiph.org/releases/opus/opus-1.3.1.tar.gz" \
            "opus"

        # 22. Oggå®¹å™¨æ ¼å¼åº“ï¼ˆlibogg-1.3.5.tar.gz â†’ liboggï¼‰
        pull_source "libogg" \
            "https://downloads.xiph.org/releases/ogg/libogg-1.3.5.tar.gz" \
            "libogg"

        # 23. VorbiséŸ³é¢‘ç¼–ç å™¨ï¼ˆlibvorbis-1.3.7.tar.gz â†’ libvorbisï¼‰
        pull_source "libvorbis" \
            "https://downloads.xiph.org/releases/vorbis/libvorbis-1.3.7.tar.gz" \
            "libvorbis"

        # 24. Theoraè§†é¢‘ç¼–ç å™¨ï¼ˆlibtheora-1.1.1.tar.gz â†’ libtheoraï¼‰
        pull_source "libtheora" \
            "https://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.gz" \
            "libtheora"

        # 25. è§†é¢‘é˜²æŠ–åº“ï¼ˆgitå…‹éš† â†’ vidstabï¼‰
        pull_source "vid.stab" \
            "https://github.com/georgmartius/vid.stab.git" \
            "vidstab"

        # 26. å‹ç¼©åº“ï¼ˆsnappy-1.1.9.tar.gz â†’ snappyï¼‰
        pull_source "Snappy" \
            "https://github.com/google/snappy/archive/refs/tags/1.1.9.tar.gz" \
            "snappy"

        # 27. JPEG 2000åº“ï¼ˆopenjpeg-2.5.0.tar.gz â†’ openjpegï¼‰
        pull_source "OpenJPEG" \
            "https://github.com/uclouvain/openjpeg/archive/refs/tags/v2.5.0.tar.gz" \
            "openjpeg"

        # 28. AV1ç¼–ç å™¨ï¼ˆgitå…‹éš† â†’ aomï¼‰
        pull_source "AOM" \
            "https://aomedia.googlesource.com/aom" \
            "aom"

        # 29. WebPå›¾åƒåº“ï¼ˆlibwebp-1.1.0.tar.gz â†’ libwebpï¼‰
        pull_source "libwebp" \
            "https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.1.0.tar.gz" \
            "libwebp"

        # 30. å›¾åƒç¼©æ”¾åº“ï¼ˆzimg-release-3.0.2.tar.gz â†’ zimgï¼‰
        pull_source "zimg" \
            "https://github.com/sekrit-twc/zimg/archive/refs/tags/release-3.0.2.tar.gz" \
            "zimg"

        # 31. AV1ç¼–ç å™¨ï¼ˆgitå…‹éš† â†’ svt-av1ï¼‰
        pull_source "SVT-AV1" \
            "https://github.com/AOMediaCodec/SVT-AV1.git" \
            "svt-av1"

        # 32. HEVCç¼–ç å™¨ï¼ˆkvazaar-2.2.0.tar.gz â†’ kvazaarï¼‰
        pull_source "Kvazaar" \
            "https://github.com/ultravideo/kvazaar/archive/refs/tags/v2.2.0.tar.gz" \
            "kvazaar"

        # 33. UDFæ ¼å¼è¯»å–åº“ï¼ˆgitå…‹éš† â†’ libudfreadï¼‰
        pull_source "libudfread" \
            "https://code.videolan.org/videolan/libudfread.git" \
            "libudfread"

        # 34. è“å…‰æ’­æ”¾åº“ï¼ˆgitå…‹éš† â†’ libblurayï¼‰
        pull_source "libbluray" \
            "https://code.videolan.org/videolan/libbluray.git" \
            "libbluray"

        # 35. FFmpegä¸»ç¨‹åºï¼ˆgitå…‹éš† â†’ ffmpegï¼‰
        pull_source "FFmpeg" \
            "https://github.com/FFmpeg/FFmpeg.git" \
            "ffmpeg"

        echo -e "\nğŸ‰ æ‰€æœ‰æºç æ‹‰å–å®Œæˆï¼å­˜æ”¾ç›®å½•ï¼š${COMPILED}"
        echo "ä¸‹ä¸€æ­¥ï¼šæ‰§è¡Œç¼–è¯‘è„šæœ¬å¼€å§‹ç¼–è¯‘"

    - name: ç¼–è¯‘å…¨éƒ¨ç»„ä»¶ï¼ˆä½¿ç”¨ç»Ÿä¸€ç›®å½•åï¼‰
      run: |
        # å®šä¹‰ç¼–è¯‘è¾“å‡ºç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰
        SOURCE="${GITHUB_WORKSPACE}/sw"
        COMPILED="${GITHUB_WORKSPACE}/compile"

        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p ${SOURCE} || { echo "âŒ æ— æ³•åˆ›å»ºè¾“å‡ºç›®å½•${SOURCE}"; exit 1; }
        echo "ğŸ“‚ ç¼–è¯‘è¾“å‡ºç›®å½•: ${SOURCE}"

        # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼–è¯‘çš„å·¥å…·å’Œåº“ï¼‰
        export PATH=${SOURCE}/bin:$PATH
        export CC=clang  # ä½¿ç”¨Clangç¼–è¯‘å™¨ï¼ˆApple Siliconä¼˜åŒ–ï¼‰
        export PKG_CONFIG_PATH="${SOURCE}/lib/pkgconfig"  # æŒ‡å®špkg-configæŸ¥æ‰¾è·¯å¾„

        # ç¼–è¯‘NASMï¼ˆæ±‡ç¼–å™¨ï¼Œç›®å½•ï¼šnasmï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ NASM'
        cd ${COMPILED}/nasm || { echo "âŒ æ‰¾ä¸åˆ°NASMæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} || { echo "âŒ NASMé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ NASMç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ NASMå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘pkg-configï¼ˆåŒ…ç®¡ç†å·¥å…·ï¼Œç›®å½•ï¼špkg-configï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ pkg-config'
        cd ${COMPILED}/pkg-config || { echo "âŒ æ‰¾ä¸åˆ°pkg-configæºç ç›®å½•"; exit 1; }
        export LDFLAGS="-framework Foundation -framework Cocoa"
        ./configure --prefix=${SOURCE} \
            --with-pc-path=${SOURCE}/lib/pkgconfig \
            --with-internal-glib \
            --disable-shared \
            --enable-static || { echo "âŒ pkg-configé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ pkg-configç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ pkg-configå®‰è£…å¤±è´¥"; exit 1; }
        unset LDFLAGS
        sleep 1

        # ç¼–è¯‘XZï¼ˆå‹ç¼©å·¥å…·ï¼Œç›®å½•ï¼šxzï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ XZ'
        cd ${COMPILED}/xz || { echo "âŒ æ‰¾ä¸åˆ°XZæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static \
            --disable-docs \
            --disable-examples || { echo "âŒ XZé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ XZç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ XZå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘ZLIBï¼ˆå‹ç¼©åº“ï¼Œç›®å½•ï¼šzlibï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ ZLIB'
        cd ${COMPILED}/zlib || { echo "âŒ æ‰¾ä¸åˆ°ZLIBæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} --static || { echo "âŒ ZLIBé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ ZLIBç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ ZLIBå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘CMakeï¼ˆæ„å»ºå·¥å…·ï¼Œç›®å½•ï¼šcmakeï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ CMake'
        cd ${COMPILED}/cmake || { echo "âŒ æ‰¾ä¸åˆ°CMakeæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} || { echo "âŒ CMakeé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ CMakeç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ CMakeå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘libxml2ï¼ˆXMLè§£æåº“ï¼Œç›®å½•ï¼šlibxml2ï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libxml2'
        cd ${COMPILED}/libxml2 || { echo "âŒ æ‰¾ä¸åˆ°libxml2æºç ç›®å½•"; exit 1; }
        ./autogen.sh || { echo "âŒ libxml2è‡ªåŠ¨ç”Ÿæˆé…ç½®å¤±è´¥"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static \
            --without-python || { echo "âŒ libxml2é…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libxml2ç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libxml2å®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘LAMEï¼ˆMP3ç¼–ç å™¨ï¼Œç›®å½•ï¼šlameï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ LAME'
        cd ${COMPILED}/lame || { echo "âŒ æ‰¾ä¸åˆ°LAMEæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static || { echo "âŒ LAMEé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ LAMEç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ LAMEå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘x264ï¼ˆH.264ç¼–ç å™¨ï¼Œç›®å½•ï¼šx264ï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ x264'
        cd ${COMPILED}/x264 || { echo "âŒ æ‰¾ä¸åˆ°x264æºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static \
            --enable-pic || { echo "âŒ x264é…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ x264ç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ x264å®‰è£…å¤±è´¥"; exit 1; }
        make install-lib-static || { echo "âŒ x264é™æ€åº“å®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘x265ï¼ˆH.265ç¼–ç å™¨ï¼Œç›®å½•ï¼šx265Neonï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ x265'
        rm -f ${SOURCE}/include/x265*.h 2>/dev/null
        rm -f ${SOURCE}/lib/libx265.a 2>/dev/null

        # ç¼–è¯‘12bitç‰ˆæœ¬
        echo 'â™»ï¸ x265 12bit'
        cd ${COMPILED}/x265Neon/source || { echo "âŒ æ‰¾ä¸åˆ°x265æºç ç›®å½•"; exit 1; }
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DHIGH_BIT_DEPTH=ON \
            -DMAIN12=ON \
            -DENABLE_SHARED=NO \
            -DEXPORT_C_API=NO \
            -DENABLE_CLI=OFF . || { echo "âŒ x265 12bité…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ x265 12bitç¼–è¯‘å¤±è´¥"; exit 1; }
        mv libx265.a libx265_main12.a || { echo "âŒ é‡å‘½åx265 12bitåº“å¤±è´¥"; exit 1; }
        make clean-generated || { echo "âŒ æ¸…ç†x265 12bitä¸´æ—¶æ–‡ä»¶å¤±è´¥"; exit 1; }
        rm CMakeCache.txt || { echo "âŒ åˆ é™¤x265 CMakeç¼“å­˜å¤±è´¥"; exit 1; }

        # ç¼–è¯‘10bitç‰ˆæœ¬
        echo 'â™»ï¸ x265 10bit'
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DHIGH_BIT_DEPTH=ON \
            -DMAIN10=ON \
            -DENABLE_HDR10_PLUS=ON \
            -DENABLE_SHARED=NO \
            -DEXPORT_C_API=NO \
            -DENABLE_CLI=OFF . || { echo "âŒ x265 10bité…ç½®å¤±è´¥"; exit 1; }
        make clean || { echo "âŒ æ¸…ç†x265 10bitä¸´æ—¶æ–‡ä»¶å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ x265 10bitç¼–è¯‘å¤±è´¥"; exit 1; }
        mv libx265.a libx265_main10.a || { echo "âŒ é‡å‘½åx265 10bitåº“å¤±è´¥"; exit 1; }
        make clean-generated || { echo "âŒ æ¸…ç†x265 10bitä¸´æ—¶æ–‡ä»¶å¤±è´¥"; exit 1; }
        rm CMakeCache.txt || { echo "âŒ åˆ é™¤x265 CMakeç¼“å­˜å¤±è´¥"; exit 1; }

        # ç¼–è¯‘ä¸»ç‰ˆæœ¬ï¼ˆåˆå¹¶10/12bitåº“ï¼‰
        echo 'â™»ï¸ x265 full'
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DEXTRA_LIB="x265_main10.a;x265_main12.a" \
            -DEXTRA_LINK_FLAGS=-L. \
            -DLINKED_10BIT=ON \
            -DLINKED_12BIT=ON \
            -DENABLE_SHARED=OFF \
            -DENABLE_CLI=OFF . || { echo "âŒ x265 ä¸»ç‰ˆæœ¬é…ç½®å¤±è´¥"; exit 1; }
        make clean || { echo "âŒ æ¸…ç†x265ä¸»ç‰ˆæœ¬ä¸´æ—¶æ–‡ä»¶å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ x265ä¸»ç‰ˆæœ¬ç¼–è¯‘å¤±è´¥"; exit 1; }
        mv libx265.a libx265_main.a || { echo "âŒ é‡å‘½åx265ä¸»åº“å¤±è´¥"; exit 1; }
        libtool -static -o libx265.a libx265_main.a libx265_main10.a libx265_main12.a 2>/dev/null || { echo "âŒ åˆå¹¶x265åº“å¤±è´¥"; exit 1; }
        make install || { echo "âŒ x265å®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘libvpxï¼ˆVP8/VP9ç¼–ç å™¨ï¼Œç›®å½•ï¼šlibvpxï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libvpx'
        cd ${COMPILED}/libvpx || { echo "âŒ æ‰¾ä¸åˆ°libvpxæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --enable-vp8 \
            --enable-postproc \
            --enable-vp9-postproc \
            --enable-vp9-highbitdepth \
            --disable-examples \
            --disable-docs \
            --enable-multi-res-encoding \
            --disable-unit-tests \
            --enable-pic \
            --disable-shared || { echo "âŒ libvpxé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libvpxç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libvpxå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘Expatï¼ˆXMLè§£æåº“ï¼Œç›®å½•ï¼šexpatï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Expat'
        cd ${COMPILED}/expat || { echo "âŒ æ‰¾ä¸åˆ°Expatæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static || { echo "âŒ Expaté…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ Expatç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ Expatå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘Gettextï¼ˆå›½é™…åŒ–åº“ï¼Œç›®å½•ï¼šgettextï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Gettext'
        cd ${COMPILED}/gettext || { echo "âŒ æ‰¾ä¸åˆ°Gettextæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-dependency-tracking \
            --disable-silent-rules \
            --disable-debug \
            --with-included-gettext \
            --with-included-glib \
            --with-included-libcroco \
            --with-included-libunistring \
            --with-included-libxml \
            --with-emacs \
            --disable-java \
            --disable-native-java \
            --disable-csharp \
            --disable-shared \
            --enable-static \
            --without-git \
            --without-cvs \
            --disable-docs \
            --disable-examples || { echo "âŒ Gettexté…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ Gettextç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ Gettextå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘libpngï¼ˆPNGå›¾åƒå¤„ç†ï¼Œç›®å½•ï¼šlibpngï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libpng'
        cd ${COMPILED}/libpng || { echo "âŒ æ‰¾ä¸åˆ°libpngæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-dependency-tracking \
            --disable-silent-rules \
            --enable-static \
            --disable-shared || { echo "âŒ libpngé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libpngç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libpngå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘Encaï¼ˆç¼–ç æ£€æµ‹åº“ï¼Œç›®å½•ï¼šencaï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Enca'
        cd ${COMPILED}/enca || { echo "âŒ æ‰¾ä¸åˆ°Encaæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static || { echo "âŒ Encaé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ Encaç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ Encaå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘FriBidiï¼ˆæ–‡æœ¬æ’ç‰ˆåº“ï¼Œç›®å½•ï¼šfribidiï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ FriBidi'
        cd ${COMPILED}/fribidi || { echo "âŒ æ‰¾ä¸åˆ°FriBidiæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static \
            --disable-silent-rules \
            --disable-debug \
            --disable-dependency-tracking || { echo "âŒ FriBidié…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ FriBidiç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ FriBidiå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘FreeTypeï¼ˆå­—ä½“æ¸²æŸ“åº“ï¼Œç›®å½•ï¼šfreetypeï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ FreeType'
        cd ${COMPILED}/freetype || { echo "âŒ æ‰¾ä¸åˆ°FreeTypeæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static \
            --enable-freetype-config || { echo "âŒ FreeTypeé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ FreeTypeç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ FreeTypeå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘Fontconfigï¼ˆå­—ä½“é…ç½®åº“ï¼Œç›®å½•ï¼šfontconfigï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Fontconfig'
        cd ${COMPILED}/fontconfig || { echo "âŒ æ‰¾ä¸åˆ°Fontconfigæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --enable-iconv \
            --disable-libxml2 \
            --disable-dependency-tracking \
            --disable-silent-rules \
            --disable-shared \
            --enable-static || { echo "âŒ Fontconfigé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ Fontconfigç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ Fontconfigå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘HarfBuzzï¼ˆæ–‡å­—æ’ç‰ˆå¼•æ“ï¼Œç›®å½•ï¼šharfbuzzï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ HarfBuzz'
        cd ${COMPILED}/harfbuzz || { echo "âŒ æ‰¾ä¸åˆ°HarfBuzzæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static || { echo "âŒ HarfBuzzé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ HarfBuzzç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ HarfBuzzå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘SDL2ï¼ˆå¤šåª’ä½“åº“ï¼Œç›®å½•ï¼šsdl2ï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ SDL2'
        cd ${COMPILED}/sdl2 || { echo "âŒ æ‰¾ä¸åˆ°SDL2æºç ç›®å½•"; exit 1; }
        ./autogen.sh || { echo "âŒ SDL2è‡ªåŠ¨ç”Ÿæˆé…ç½®å¤±è´¥"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static \
            --without-x \
            --enable-hidapi || { echo "âŒ SDL2é…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ SDL2ç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ SDL2å®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘libassï¼ˆå­—å¹•æ¸²æŸ“åº“ï¼Œç›®å½•ï¼šlibassï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libass'
        cd ${COMPILED}/libass || { echo "âŒ æ‰¾ä¸åˆ°libassæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-fontconfig \
            --disable-shared \
            --enable-static || { echo "âŒ libassé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libassç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libasså®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘Opusï¼ˆéŸ³é¢‘ç¼–ç å™¨ï¼Œç›®å½•ï¼šopusï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Opus'
        cd ${COMPILED}/opus || { echo "âŒ æ‰¾ä¸åˆ°Opusæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static || { echo "âŒ Opusé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ Opusç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ Opuså®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘liboggï¼ˆOggå®¹å™¨æ ¼å¼ï¼Œç›®å½•ï¼šliboggï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libogg'
        cd ${COMPILED}/libogg || { echo "âŒ æ‰¾ä¸åˆ°liboggæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static \
            --disable-dependency-tracking || { echo "âŒ liboggé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ liboggç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ liboggå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘libvorbisï¼ˆVorbiséŸ³é¢‘ç¼–ç å™¨ï¼Œç›®å½•ï¼šlibvorbisï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libvorbis'
        cd ${COMPILED}/libvorbis || { echo "âŒ æ‰¾ä¸åˆ°libvorbisæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --with-ogg-libraries=${SOURCE}/lib \
            --with-ogg-includes=${SOURCE}/include/ \
            --enable-static \
            --disable-shared || { echo "âŒ libvorbisé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libvorbisç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libvorbiså®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘libtheoraï¼ˆTheoraè§†é¢‘ç¼–ç å™¨ï¼Œç›®å½•ï¼šlibtheoraï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libtheora'
        cd ${COMPILED}/libtheora || { echo "âŒ æ‰¾ä¸åˆ°libtheoraæºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-asm \
            --with-ogg-libraries=${SOURCE}/lib \
            --with-ogg-includes=${SOURCE}/include/ \
            --with-vorbis-libraries=${SOURCE}/lib \
            --with-vorbis-includes=${SOURCE}/include/ \
            --enable-static \
            --disable-shared || { echo "âŒ libtheoraé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libtheoraç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libtheoraå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘vid.stabï¼ˆè§†é¢‘é˜²æŠ–åº“ï¼Œç›®å½•ï¼švidstabï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ vid.stab'
        cd ${COMPILED}/vidstab || { echo "âŒ æ‰¾ä¸åˆ°vid.stabæºç ç›®å½•"; exit 1; }
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DLIBTYPE=STATIC \
            -DBUILD_SHARED_LIBS=OFF \
            -DUSE_OMP=OFF \
            -DENABLE_SHARED=off . || { echo "âŒ vid.stabé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ vid.stabç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ vid.stabå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘Snappyï¼ˆå‹ç¼©åº“ï¼Œç›®å½•ï¼šsnappyï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Snappy'
        cd ${COMPILED}/snappy || { echo "âŒ æ‰¾ä¸åˆ°Snappyæºç ç›®å½•"; exit 1; }
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DENABLE_SHARED=OFF \
            -DENABLE_CLI=OFF . || { echo "âŒ Snappyé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ Snappyç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ Snappyå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘OpenJPEGï¼ˆJPEG 2000åº“ï¼Œç›®å½•ï¼šopenjpegï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ OpenJPEG'
        cd ${COMPILED}/openjpeg || { echo "âŒ æ‰¾ä¸åˆ°OpenJPEGæºç ç›®å½•"; exit 1; }
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DENABLE_C_DEPS=ON \
            -DLIBTYPE=STATIC \
            -DENABLE_SHARED=OFF \
            -DENABLE_STATIC=ON . || { echo "âŒ OpenJPEGé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ OpenJPEGç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ OpenJPEGå®‰è£…å¤±è´¥"; exit 1; }
        # æ¸…ç†å¯èƒ½æ®‹ç•™çš„åŠ¨æ€åº“
        rm ${SOURCE}/lib/libopenjp2.2.5.0.dy* 2>/dev/null
        rm ${SOURCE}/lib/libopenjp2.dy* 2>/dev/null
        rm ${SOURCE}/lib/libopenjp2.7.dy* 2>/dev/null
        sleep 1

        # ç¼–è¯‘AOMï¼ˆAV1ç¼–ç å™¨ï¼Œç›®å½•ï¼šaomï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ AOM'
        cd ${COMPILED}/aom || { echo "âŒ æ‰¾ä¸åˆ°AOMæºç ç›®å½•"; exit 1; }
        mkdir -p aom_build || { echo "âŒ æ— æ³•åˆ›å»ºAOMæ„å»ºç›®å½•"; exit 1; }
        cd aom_build || { echo "âŒ è¿›å…¥AOMæ„å»ºç›®å½•å¤±è´¥"; exit 1; }
        cmake ${COMPILED}/aom \
            -DENABLE_TESTS=0 \
            -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DLIBTYPE=STATIC \
            -DAOM_TARGET_CPU=ARM64 \
            -DCONFIG_RUNTIME_CPU_DETECT=0 || { echo "âŒ AOMé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ AOMç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ AOMå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘libwebpï¼ˆWebPå›¾åƒåº“ï¼Œç›®å½•ï¼šlibwebpï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libwebp'
        cd ${COMPILED}/libwebp || { echo "âŒ æ‰¾ä¸åˆ°libwebpæºç ç›®å½•"; exit 1; }
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DENABLE_C_DEPS=ON \
            -DLIBTYPE=STATIC \
            -DENABLE_SHARED=OFF \
            -DENABLE_STATIC=ON . || { echo "âŒ libwebpé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libwebpç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libwebpå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘zimgï¼ˆå›¾åƒç¼©æ”¾åº“ï¼Œç›®å½•ï¼šzimgï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ zimg'
        cd ${COMPILED}/zimg || { echo "âŒ æ‰¾ä¸åˆ°zimgæºç ç›®å½•"; exit 1; }
        ./autogen.sh || { echo "âŒ zimgè‡ªåŠ¨ç”Ÿæˆé…ç½®å¤±è´¥"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static || { echo "âŒ zimgé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ zimgç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ zimgå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘SVT-AV1ï¼ˆAV1ç¼–ç å™¨ï¼Œç›®å½•ï¼šsvt-av1ï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ SVT-AV1'
        cd ${COMPILED}/svt-av1 || { echo "âŒ æ‰¾ä¸åˆ°SVT-AV1æºç ç›®å½•"; exit 1; }
        cmake -DCMAKE_INSTALL_PREFIX:PATH=${SOURCE} \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_DEC=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            -DLIBTYPE=STATIC \
            -DENABLE_SHARED=OFF \
            -DENABLE_STATIC=ON . || { echo "âŒ SVT-AV1é…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ SVT-AV1ç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ SVT-AV1å®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘Kvazaarï¼ˆHEVCç¼–ç å™¨ï¼Œç›®å½•ï¼škvazaarï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ Kvazaar'
        cd ${COMPILED}/kvazaar || { echo "âŒ æ‰¾ä¸åˆ°Kvazaaræºç ç›®å½•"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static || { echo "âŒ Kvazaaré…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ Kvazaarç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ Kvazaarå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘libudfreadï¼ˆUDFæ ¼å¼è¯»å–åº“ï¼Œç›®å½•ï¼šlibudfreadï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libudfread'
        cd ${COMPILED}/libudfread || { echo "âŒ æ‰¾ä¸åˆ°libudfreadæºç ç›®å½•"; exit 1; }
        ./bootstrap || { echo "âŒ libudfreadè‡ªåŠ¨ç”Ÿæˆé…ç½®å¤±è´¥"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static || { echo "âŒ libudfreadé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libudfreadç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libudfreadå®‰è£…å¤±è´¥"; exit 1; }
        sleep 1

        # ç¼–è¯‘libblurayï¼ˆè“å…‰æ’­æ”¾åº“ï¼Œç›®å½•ï¼šlibblurayï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ libbluray'
        cd ${COMPILED}/libbluray || { echo "âŒ æ‰¾ä¸åˆ°libblurayæºç ç›®å½•"; exit 1; }
        ./bootstrap || { echo "âŒ libblurayè‡ªåŠ¨ç”Ÿæˆé…ç½®å¤±è´¥"; exit 1; }
        ./configure --prefix=${SOURCE} \
            --disable-shared \
            --enable-static \
            --disable-dependency-tracking \
            --disable-silent-rules \
            --without-libxml2 \
            --without-freetype \
            --disable-doxygen-doc \
            --disable-bdjava-jar || { echo "âŒ libblurayé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ libblurayç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ libblurayå®‰è£…å¤±è´¥"; exit 1; }

        # ç¼–è¯‘FFmpegä¸»ç¨‹åºï¼ˆç›®å½•ï¼šffmpegï¼‰
        echo 'â™»ï¸ å¼€å§‹ç¼–è¯‘ FFmpeg'
        cd ${COMPILED}/ffmpeg || { echo "âŒ æ‰¾ä¸åˆ°FFmpegæºç ç›®å½•"; exit 1; }
        # é…ç½®ç¼–è¯‘å‚æ•°ï¼ˆé“¾æ¥æ‰€æœ‰ä¾èµ–åº“ï¼‰
        export LDFLAGS="-L${SOURCE}/lib"
        export CFLAGS="-I${SOURCE}/include"
        export LDFLAGS="$LDFLAGS -framework VideoToolbox"  # å¯ç”¨macOSç¡¬ä»¶åŠ é€Ÿ
        ./configure \
            --prefix=${SOURCE} \
            --extra-cflags="-fno-stack-check" \
            --arch=arm64 \
            --cc=/usr/bin/clang \
            --enable-gpl \
            --enable-libbluray \
            --enable-libopenjpeg \
            --enable-libopus \
            --enable-libmp3lame \
            --enable-libx264 \
            --enable-libx265 \
            --enable-libvpx \
            --enable-libwebp \
            --enable-libass \
            --enable-libfreetype \
            --enable-fontconfig \
            --enable-libtheora \
            --enable-libvorbis \
            --enable-libsnappy \
            --enable-libaom \
            --enable-libvidstab \
            --enable-libzimg \
            --enable-libsvtav1 \
            --enable-libkvazaar \
            --enable-libharfbuzz \
            --pkg-config-flags=--static \
            --enable-ffplay \
            --enable-postproc \
            --enable-neon \
            --enable-runtime-cpudetect \
            --disable-indev=qtkit \
            --disable-indev=x11grab_xcb || { echo "âŒ FFmpegé…ç½®å¤±è´¥"; exit 1; }
        make -j$(nproc) || { echo "âŒ FFmpegç¼–è¯‘å¤±è´¥"; exit 1; }
        make install || { echo "âŒ FFmpegå®‰è£…å¤±è´¥"; exit 1; }

    - name: æµ‹è¯•ç¼–è¯‘ç»“æœ
      run: |
        # äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„
        export BIN_DIR="${GITHUB_WORKSPACE}/sw/bin"
        
        # éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§
        if [ ! -f "${BIN_DIR}/ffmpeg" ]; then
            echo "âŒ ffmpegäºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
        fi
        if [ ! -f "${BIN_DIR}/ffprobe" ]; then
            echo "âŒ ffprobeäºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
        fi
        
        # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
        echo "ğŸ“Œ FFmpegç‰ˆæœ¬ä¿¡æ¯ï¼š"
        ${BIN_DIR}/ffmpeg -version | head -1
        ${BIN_DIR}/ffprobe -version | head -1
        
        # éªŒè¯æ¶æ„ï¼ˆç¡®ä¿ä¸ºARM64ï¼‰
        echo -e "\nğŸ“Œ äºŒè¿›åˆ¶æ–‡ä»¶æ¶æ„ï¼š"
        file ${BIN_DIR}/ffmpeg | head -1
        
        # æµ‹è¯•VideoToolboxç¡¬ä»¶åŠ é€Ÿæ”¯æŒ
        echo -e "\nğŸ“Œ ç¡¬ä»¶åŠ é€Ÿæ£€æµ‹ï¼š"
        if ${BIN_DIR}/ffmpeg -hide_banner -encoders 2>/dev/null | grep -q videotoolbox; then
            echo "âœ… VideoToolboxç¡¬ä»¶åŠ é€Ÿå·²å¯ç”¨"
        else
            echo "âŒ VideoToolboxç¡¬ä»¶åŠ é€Ÿç¼ºå¤±"
            exit 1
        fi
        
        # æµ‹è¯•è¿åŠ¨å‘é‡æ”¯æŒ
        echo -e "\nğŸ“Œ åŠŸèƒ½æ£€æµ‹ï¼š"
        if ${BIN_DIR}/ffmpeg -hide_banner -filters 2>/dev/null | grep -q codecview; then
            echo "âœ… è¿åŠ¨å‘é‡æ”¯æŒå·²å¯ç”¨"
        else
            echo "âŒ è¿åŠ¨å‘é‡æ”¯æŒç¼ºå¤±"
            exit 1
        fi
        
        echo -e "\nâœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"

    - name: æ‰“åŒ…äºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release || { echo "âŒ æ— æ³•åˆ›å»ºå‘å¸ƒç›®å½•"; exit 1; }
        
        # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
        cp ${GITHUB_WORKSPACE}/sw/bin/ffmpeg release/ || { echo "âŒ å¤åˆ¶ffmpegå¤±è´¥"; exit 1; }
        cp ${GITHUB_WORKSPACE}/sw/bin/ffprobe release/ || { echo "âŒ å¤åˆ¶ffprobeå¤±è´¥"; exit 1; }
        cp ${GITHUB_WORKSPACE}/sw/bin/ffplay release/ 2>/dev/null || echo "âš ï¸ ffplayæœªæ‰¾åˆ°ï¼Œè·³è¿‡å¤åˆ¶"
        
        # æ‰“åŒ…ä¸ºtar.gzï¼ˆåŒ…å«åˆ†æ”¯åï¼‰
        cd release || { echo "âŒ è¿›å…¥å‘å¸ƒç›®å½•å¤±è´¥"; exit 1; }
        tar -czf ../ffmpeg-apple-silicon-native-${{ github.ref_name }}.tar.gz * || { echo "âŒ æ‰“åŒ…å¤±è´¥"; exit 1; }
        cd ..
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        shasum -a 256 ffmpeg-apple-silicon-native-${{ github.ref_name }}.tar.gz > checksums.txt || { echo "âŒ ç”Ÿæˆæ ¡éªŒå’Œå¤±è´¥"; exit 1; }
        
        echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…å®Œæˆ"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-apple-silicon-native
        path: |
          ffmpeg-apple-silicon-native-*.tar.gz
          checksums.txt
        retention-days: 30  # äº§ç‰©ä¿ç•™30å¤©